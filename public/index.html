<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Swift Algo Auto Trader</title>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <!-- Fonts & Styling -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background: #0d1117;
      color: #c9d1d9;
    }

    .dashboard {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      padding: 30px;
    }

    .card {
      background: #161b22;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
    }

    .control-panel button {
      background: #238636;
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 10px;
    }

    .control-panel button:hover {
      background: #2ea043;
    }

    select, input[type="number"] {
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 8px;
      background: #0d1117;
      color: white;
      margin-top: 5px;
      margin-bottom: 15px;
    }

    .log {
      height: 250px;
      overflow-y: auto;
      background: #0d1117;
      border: 1px solid #30363d;
      padding: 10px;
      border-radius: 8px;
      font-size: 14px;
    }

    #authOverlay {
      position: fixed;
      inset: 0;
      background: #0d1117;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    #authOverlay input, #authOverlay button {
      margin-top: 10px;
      font-size: 16px;
      padding: 10px;
      border-radius: 8px;
      border: none;
    }

    #authOverlay input {
      background: #161b22;
      color: white;
      border: 1px solid #30363d;
      width: 220px;
    }

    #authOverlay button {
      background: #238636;
      color: white;
      cursor: pointer;
    }

    #authError {
      color: #f85149;
      margin-top: 10px;
      display: none;
    }

    footer {
      background: #161b22;
      padding: 15px;
      color: #8b949e;
      text-align: center;
      border-top: 1px solid #30363d;
      font-size: 12px;
    }
  </style>
</head>

<body>

<!-- 🔐 Password Auth -->
<div id="authOverlay">
  <h2>Enter Password</h2>
  <input type="password" id="passwordInput" placeholder="Password" />
  <button onclick="checkPassword()">Login</button>
  <p id="authError">Wrong password</p>
</div>

<!-- 📊 Dashboard -->
<div class="dashboard" id="dashboard" style="display:none;">
  <!-- Chart Section -->
  <div class="card">
    <h2>SMA Crossover Chart</h2>
    <canvas id="tradeChart" height="300"></canvas>
  </div>

  <!-- Controls & Trade Log -->
  <div class="card control-panel">
    <h2>Trading Control</h2>

    <label for="pairSelect">Pair</label>
    <select id="pairSelect">
      <option value="BTCUSDT">BTC/USDT</option>
      <option value="ETHUSDT">ETH/USDT</option>
      <option value="BNBUSDT">BNB/USDT</option>
      <option value="SOLUSDT">SOL/USDT</option>
      <option value="XRPUSDT">XRP/USDT</option>
    </select>

    <label for="qtyInput">Quantity</label>
    <input type="number" id="qtyInput" step="0.0001" value="0.001" />

    <label for="timeframeSelect">Timeframe</label>
    <select id="timeframeSelect">
      <option value="60000">1 Minute</option>
      <option value="300000" selected>5 Minutes</option>
      <option value="900000">15 Minutes</option>
    </select>

    <p>Status: <strong id="status">Stopped</strong></p>
    <button onclick="toggleTrading()">Start Auto Trading</button>

    <h3>Trade Log</h3>
    <div class="log" id="tradeLog"></div>
  </div>
</div>

<!-- ℹ️ Disclaimer -->
<footer>
  <strong>Disclaimer:</strong> Cryptocurrency trading involves risk. Use at your own discretion.
</footer>

<!-- 🔐 Auth Logic -->
<script>
  const HARDCODED_PASSWORD = 'just4pat';

  function checkPassword() {
    const input = document.getElementById('passwordInput').value;
    if (input === HARDCODED_PASSWORD) {
      document.getElementById('authOverlay').style.display = 'none';
      document.getElementById('dashboard').style.display = 'grid';
      initChart();
    } else {
      const error = document.getElementById('authError');
      error.style.display = 'block';
    }
  }
</script>

<!-- 📊 Chart + Bot Logic -->
<script>
  const API_BASE_URL = window.location.hostname.includes('localhost')
    ? 'http://localhost:3000'
    : 'https://autopatobot.onrender.com';

  let chart, tradingInterval, autoTrading = false, activePosition = null;
  const maxCandles = 50, dataPoints = [];

  function initChart() {
    const ctx = document.getElementById('tradeChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'candlestick',
      data: {
        datasets: [
          { label: 'Price', data: [], borderColor: '#58a6ff' },
          { label: 'SMA 5', data: [], type: 'line', borderColor: '#ff7b72', borderDash: [5, 5], pointRadius: 0 },
          { label: 'SMA 10', data: [], type: 'line', borderColor: '#f2cc60', borderDash: [10, 5], pointRadius: 0 }
        ]
      },
      options: {
        plugins: { legend: { labels: { color: '#c9d1d9' } } },
        scales: {
          x: { type: 'time', time: { unit: 'minute' }, ticks: { color: '#8b949e' } },
          y: { ticks: { color: '#8b949e' } }
        }
      }
    });
    startTradingLoop();
  }

  async function fetchCandle() {
    const symbol = document.getElementById('pairSelect').value;
    try {
      const res = await axios.get(`${API_BASE_URL}/api/candle?symbol=${symbol}`);
      const { time, open, high, low, close } = res.data;
      return { t: time, o: open, h: high, l: low, c: close };
    } catch (e) {
      console.error('Candle fetch failed:', e);
      return null;
    }
  }

  function calculateSMA(data, period) {
    if (data.length < period) return null;
    const sum = data.slice(-period).reduce((acc, val) => acc + val, 0);
    return sum / period;
  }

  function getSMASignal() {
    if (dataPoints.length < 11) return 'HOLD';
    const [sma5, sma10] = [calculateSMA(dataPoints, 5), calculateSMA(dataPoints, 10)];
    const [prev5, prev10] = [calculateSMA(dataPoints.slice(0, -1), 5), calculateSMA(dataPoints.slice(0, -1), 10)];

    if (prev5 <= prev10 && sma5 > sma10) return 'BUY';
    if (prev5 >= prev10 && sma5 < sma10) return 'SELL';
    return 'HOLD';
  }

  function updateChart(candle) {
    const [cs, sma5, sma10] = chart.data.datasets;
    cs.data.push(candle);
    dataPoints.push(candle.c);

    if (cs.data.length > maxCandles) {
      cs.data.shift(); sma5.data.shift(); sma10.data.shift(); dataPoints.shift();
    }

    const s5 = calculateSMA(dataPoints, 5);
    const s10 = calculateSMA(dataPoints, 10);

    if (s5) sma5.data.push({ x: candle.t, y: s5 });
    if (s10) sma10.data.push({ x: candle.t, y: s10 });

    chart.update();
  }

  function startTradingLoop() {
    const interval = parseInt(document.getElementById('timeframeSelect').value);
    if (tradingInterval) clearInterval(tradingInterval);

    tradingInterval = setInterval(async () => {
      const candle = await fetchCandle();
      if (!candle) return;

      updateChart(candle);

      if (autoTrading) {
        const signal = getSMASignal();
        const price = candle.c;
        const time = new Date(candle.t).toLocaleTimeString();

        if (!activePosition) {
          if (signal === 'BUY') {
            activePosition = { type: 'buy', entry: price, sl: price * 0.99, tp: price * 1.02 };
            executeTrade('buy');
            logTrade(`${time} | BUY @ ${price.toFixed(2)}`);
          } else if (signal === 'SELL') {
            activePosition = { type: 'sell', entry: price, sl: price * 1.01, tp: price * 0.98 };
            executeTrade('sell');
            logTrade(`${time} | SELL @ ${price.toFixed(2)}`);
          }
        } else {
          const { type, sl, tp } = activePosition;
          const hitTP = type === 'buy' ? price >= tp : price <= tp;
          const hitSL = type === 'buy' ? price <= sl : price >= sl;

          if (hitTP || hitSL) {
            const closeAction = type === 'buy' ? 'sell' : 'buy';
            executeTrade(closeAction);
            logTrade(`${time} | ${type.toUpperCase()} ${hitTP ? 'TP' : 'SL'} hit @ ${price.toFixed(2)}`);
            activePosition = null;
          } else {
            logTrade(`${time} | ${type.toUpperCase()} position active`);
          }
        }
      }
    }, interval);
  }

  function executeTrade(action) {
    const symbol = document.getElementById('pairSelect').value;
    const quantity = parseFloat(document.getElementById('qtyInput').value);
    axios.post(`${API_BASE_URL}/api/trade`, { action, symbol, quantity })
      .then(res => console.log('Trade executed:', res.data))
      .catch(err => {
        console.error('Trade failed:', err);
        logTrade(`Trade Error: ${err.response?.data?.error || err.message}`);
      });
  }

  function logTrade(msg) {
    const log = document.getElementById('tradeLog');
    const entry = document.createElement('div');
    entry.textContent = msg;
    log.appendChild(entry);
    log.scrollTop = log.scrollHeight;
  }

  function toggleTrading() {
    autoTrading = !autoTrading;
    document.getElementById('status').innerText = autoTrading ? 'Running' : 'Stopped';
    document.querySelector('.control-panel button').innerText = autoTrading ? 'Stop Auto Trading' : 'Start Auto Trading';
    if (autoTrading) startTradingLoop();
    else clearInterval(tradingInterval);
  }
</script>

</body>
</html>